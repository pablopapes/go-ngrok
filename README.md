# go-ngrok

A Go-based daemon that:

- Periodically retrieves the public URL generated by [ngrok](https://ngrok.com/) .
- Detects when the URL changes and saves it to a `config.json` file.
- Authenticates with a remote API and sends the updated URL.

---

## Features

- Loads environment variables from a `.env` file using `github.com/joho/godotenv`.
- Maintains a JSON configuration file (`config.json`), creating and updating it automatically.
- Runs a continuous loop with `time.Ticker` to execute the update logic at regular intervals.
- Logs all actions using Goâ€™s standard `log` package.
- Includes examples for running as a systemd service on Linux or a Windows service via NSSM.

---

## Prerequisites

- Go 1.18 or higher installed.
- ngrok running locally on port `4040` (e.g., `ngrok http 80`).
- A remote API exposing two endpoints:
  - `POST /authentication_token` to obtain a JWT.
  - `POST /api/config/url` to update the URL (requires `Authorization: Bearer <token>`).
- A `.env` file containing:
  ```bash
  API_URL=https://your-api.com
  USERNAME_API=your_username
  PASSWORD_API=your_password
  ```

---

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/pablopapes/go-ngrok.git
   cd go-ngrok
   ```

2. Download Go dependencies:
   ```bash
   go mod tidy
   ```

3. Build the executable:
   ```bash
   go build -o ngrok-updater .
   ```

---

## Configuration

- **Environment Variables:** Ensure your `.env` file is in the project root with the keys above.
- **`config.json`:** On first run, the app will create `config.json` with an empty `Url` field. Subsequent URL changes will be written here.

---

## Usage

Run the application in the foreground (for testing):
```bash
./ngrok-updater
```

You will see logs printed each time the URL is checked or sent.

---

## Running as a Service on Linux (systemd)

1. Copy the binary to `/usr/local/bin`:
   ```bash
   sudo cp ngrok-updater /usr/local/bin/
   ```

2. Create a systemd unit file at `/etc/systemd/system/ngrok-updater.service`:
   ```ini
   [Unit]
   Description=Ngrok URL Updater

   [Service]
   ExecStart=/usr/local/bin/ngrok-updater
   Restart=always
   User=YOUR_USER
   WorkingDirectory=/path/to/project
   EnvironmentFile=/path/to/project/.env

   [Install]
   WantedBy=multi-user.target
   ```

3. Reload systemd and start the service:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable ngrok-updater
   sudo systemctl start ngrok-updater
   ```

4. View logs:
   ```bash
   journalctl -u ngrok-updater -f
   ```

---

## Running as a Service on Windows (NSSM)

1. Download and install [NSSM](https://nssm.cc/).
2. In PowerShell, register the service:
   ```powershell
   nssm install NgrokURLUpdater C:\path\to\ngrok-updater.exe
   nssm set NgrokURLUpdater AppDirectory C:\path\to\project
   nssm set NgrokURLUpdater AppEnvironmentExtra DOTENV_FILE=C:\path\to\.env
   nssm start NgrokURLUpdater
   ```

---

## Customization

- The default check interval is 5 minutes. Adjust the `5 * time.Minute` value in `main.go` as needed.
- Rename environment variable keys or change file paths to match your project structure.

---

## Troubleshooting

- Ensure ngrok is running and that `http://127.0.0.1:4040/api/tunnels` responds correctly.
- Verify file permissions for reading/writing `config.json`.
- Check that the remote API is reachable and that the authentication endpoint returns HTTP 200.

---
